@{
    ViewBag.Title = "Changepassword";
    Layout = "~/Views/Shared/_Layoutview.cshtml";
     var user = ViewBag.UserId;
    var usertype = ViewBag.UserType;
    var UserPassword = ViewBag.UserPassword;
    var id = ViewBag.id;
}
@model EWarranty.Models.GroupClass.ChangepassUserViewModel
<html lang="en">
<head>
    <!-- Required meta tags -->
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <title>Change Pssword</title>
  
    <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Kanit">
    <script src="http://ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.13.0/css/all.min.css">
    <link href="~/Css/LoadingSpinner.css" rel="stylesheet" />
    <style>
        form.cmxform label.error, label.error {
            color: red;
            font-style: italic;
        }

        #commentForm {
            width: 500px;
        }

            #commentForm label {
                width: 250px;
            }

                #commentForm label.error, #commentForm input.submit {
                    margin-left: 253px;
                }



        #signupForm label.error {
            margin-left: 10px;
            width: auto;
            display: inline;
        }

        #newsletter_topics label.error {
            display: none;
            margin-left: 103px;
        }
    </style>
    <style>
        /* Style all input fields */
        input {
            width: 100%;
            padding: 12px;
            border: 1px solid #ccc;
            border-radius: 4px;
            box-sizing: border-box;
            margin-top: 6px;
            margin-bottom: 16px;
        }

            /* Style the submit button */
            input[type=submit] {
                background-color: #04AA6D;
                color: white;
            }

        /* Style the container for inputs */
        .container {
            background-color: #f1f1f1;
            padding: 20px;
        }

        /* The message box is shown when the user clicks on the password field */
        #message {
            display: none;
            background: #f1f1f1;
            color: #000;
            position: relative;
            padding: 20px;
            margin-top: 10px;
        }

            #message p {
                padding: 10px 35px;
                font-size: 12px;
            }


        #messagecf {
            display: none;
            background: #f1f1f1;
            color: #000;
            position: relative;
            padding: 20px;
            margin-top: 10px;
        }

            #messagecf p {
                padding: 10px 35px;
                font-size: 18px;
            }
        #message1 {
            display: none;
            background: #f1f1f1;
            color: #000;
            position: relative;
            padding: 20px;
            margin-top: 10px;
        }

            #message1 p {
                padding: 10px 35px;
                font-size: 12px;
            }
        /* Add a green text color and a checkmark when the requirements are right */
        .valid {
            color: green;
        }

            .valid:before {
                position: relative;
                left: -35px;
                content: "✔";
            }

        /* Add a red text color and an "x" when the requirements are wrong */
        .invalid {
            color: red;
        }

            .invalid:before {
                position: relative;
                left: -35px;
                content: "✖";
            }

        .field-icon {
            float: right;
            margin-left: -41px;
            margin-top: 12px;
            position: relative;
            z-index: 2;
        }
        input[name=email] {
            pointer-events: none;
            background: #e3dada;
        }
        input[name=password] {
            pointer-events: none;
            background: #e3dada;
        }
    </style>

</head>
<body>

    <div class="container-scroller">
        <div>
            <div>
                <div class="row w-100">
                    <div class="col-lg-6 mx-auto">
                        <div class="auto-form-wrapper">
                            @*<p class="card-description"> เปลี่ยนรหัสผ่าน </p>*@
                            <h1>เปลี่ยนรหัสผ่าน</h1>
                                  <form class="cmxform" id="signupForm" method="get" action="" onsubmit="">
                                <div class="form-group">
                                    <label for="exampleInputEmail1">User ID</label>
                                    <input type="text" class="form-control" id="InputEmail1" placeholder="Enter email" name="email" value="@user">
                                    @*@Html.TextBoxFor(u => u.Userid, new { data_bind = "text", @id = "InputEmail1", @class = "form-control", @Value = "@user" })*@
                                </div>
                                <div class="form-group">
                                    <label for="exampleInputPassword1">รหัสผ่านปัจจุบัน</label>
                                    <input class="form-control" placeholder="รหัสผ่านปัจจุบัน" maxlength="8" id="password" type="password" name="password" value="@UserPassword">
                                    <span toggle="#password" class="fa fa-fw fa-eye field-icon toggle-password"></span>
                                </div>
                                <div class="form-group">
                                    <label for="exampleInputPassword1">รหัสผ่านใหม่</label>
                                    <input class="form-control" type="password" maxlength="8" placeholder="รหัสผ่านใหม่" id="confirm_password" name="confirm_password"  required>
                                    @*@Html.TextBoxFor(u => u.Password, new { data_bind = "Password", @class = "form-control", @type = "password", @name = "confirm_password", @id = "confirm_password" })*@
                                    @*<input id="confirm_password" name="password_two" type="password" pattern="^\S{8,}$" placeholder="Confirm Password" required>*@
                                    <span toggle="#confirm_password" class="fa fa-fw fa-eye field-icon toggle-cfpassword"></span>
                                </div>
                                <div class="row">
                                    <div class="col-md-8">
                                        <div id="message">
                                            <p>รหัสผ่านจะต้องประกอบด้วยสิ่งต่อไปนี้:</p>
                                            <p id="letter" class="invalid"><b>ภาษาอังกฤษตัวพิมพ์เล็ก</b></p>
                                            <p id="capital" class="invalid"><b>ภาษาอังกฤษตัวพิมพ์ใหญ่</b></p>
                                            <p id="number" class="invalid"><b>ตัวเลข</b></p>
                                            <p id="length" class="invalid"><b>ตัวอักษรมีความยาว 8 ตัวอักษร</b></p>
                                        </div>
                                       
                                    </div>

                                </div>
                                      <div class="form-group">
                                          <label for="exampleInputPassword1">ยืนยันรหัสผ่านใหม่</label>
                                          <input class="form-control" type="password" maxlength="8" placeholder="ยืนยันรหัสผ่านใหม่" id="confirm_password1" name="confirm_password1" required>
                                          @*@Html.TextBoxFor(u => u.Password, new { data_bind = "Password", @class = "form-control", @type = "password", @name = "confirm_password", @id = "confirm_password" })*@
                                          @*<input id="confirm_password" name="password_two" type="password" pattern="^\S{8,}$" placeholder="Confirm Password" required>*@
                                          <span toggle="#confirm_password1" class="fa fa-fw fa-eye field-icon toggle-cfpassword1"></span>
                                      </div>
                                      <div class="row">
                                          <div class="col-md-8">
                                              <div id="message1">
                                                  <p>รหัสผ่านจะต้องประกอบด้วยสิ่งต่อไปนี้:</p>
                                                  <p id="letter1" class="invalid"><b>ภาษาอังกฤษตัวพิมพ์เล็ก</b></p>
                                                  <p id="capital1" class="invalid"><b>ภาษาอังกฤษตัวพิมพ์ใหญ่</b></p>
                                                  <p id="number1" class="invalid"><b>ตัวเลข</b></p>
                                                  <p id="length1" class="invalid"><b>ตัวอักษรมีความยาว 8 ตัวอักษร</b></p>
                                              </div>

                                          </div>

                                      </div>


                                <span id="messagex" style="color:red"> </span> <br><br>
                                <button type="submit" class="btn btn-success mr-2">ยืนยัน</button>

                               
                                <button type="button" class="btn btn-primary" data-toggle="modal" data-target="#exampleModal">
                                    ยกเลิก
                                </button>
                            </form>
                              
                        </div>
                       

                    </div>
                </div>
            </div>
            <!-- content-wrapper ends -->
        </div>
        <!-- page-body-wrapper ends -->

    </div>
        <!-- Modal -->
        <div class="modal fade" id="exampleModal" tabindex="-1" role="dialog" aria-labelledby="exampleModalLabel" aria-hidden="true">
            <div class="modal-dialog" role="document">
                <div class="modal-content" style="background-color:rgb(180, 180, 180);">
                    <div class="modal-header">
                        <h5 class="modal-title" id="exampleModalLabel">ยืนยันยกเลิกเปลี่ยนรหัสผ่าน</h5>
                        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                            <span aria-hidden="true">&times;</span>
                        </button>
                    </div>
                    <div class="modal-body">
                        ท่านต้องการยกเลิกการเปลี่ยนรหัสผ่านใช่หรือไม่?
                    </div>
                    <div class="modal-footer">

                        <button type="button" class="btn btn-success" onclick="window.location.href = '/Account/Register';">ใช่</button>
                        <button type="button" class="btn btn-secondary" data-dismiss="modal">ไม่ใช่</button>

                    </div>
                </div>
            </div>
        </div>
        <!-- Modal -->
    <div class="modal fade" id="Modalsave" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">

        <div class="modal-dialog" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="exampleModalLabel">เปลี่ยนรหัสผ่านสำเร็จ</h5>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body">
                    เปลี่ยนรหัสผ่านสำเร็จ ระบบส่ง รหัสผ่านใหม่เข้า Email ที่ท่านลงทะเบียนเรียบร้อยแล้ว กลับสู่หน้า Login
                </div>
                <div class="modal-footer">

                    <button type="button" class="btn btn-success" onclick="urllogin()">ตกลง</button>
                    @*<button type="button" class="btn btn-secondary" data-dismiss="modal">ไม่ใช่</button>*@

                </div>
            </div>
        </div>
    </div>

    <button type="button" class="btn btn-primary" id="hiddenclick" data-toggle="modal" data-target="#Modalsave" hidden>
        ตกลง
    </button>
    <div id="overlay">
        <div class="cv-spinner">
            <span class="spinner"></span>
        </div>
    </div>
    <!-- container-scroller -->
    <!-- plugins:js -->
    <script src="~/BootstrapTemplate/src/assets/vendors/js/vendor.bundle.base.js"></script>
    <script src="~/BootstrapTemplate/src/assets/vendors/js/vendor.bundle.addons.js"></script>
    <!-- endinject -->
    <!-- Plugin js for this page-->
    <!-- End plugin js for this page-->
    <!-- inject:js -->
    <script src="~/BootstrapTemplate/src/assets/js/shared/off-canvas.js"></script>
    <script src="~/BootstrapTemplate/src/assets/js/shared/misc.js"></script>
    <!-- endinject -->
    <!-- Custom js for this page-->
    <script src="~/BootstrapTemplate/src/assets/js/demo_1/dashboard.js"></script>
    <!-- End custom js for this page-->
    <script src="~/BootstrapTemplate/src/assets/js/shared/jquery.cookie.js" type="text/javascript"></script>
    <script src="~/Scripts/jquery-validation-1.19.5/lib/jquery.js"></script>
    <script src="~/Scripts/jquery-validation-1.19.5/dist/jquery.validate.js"></script>
    <!-- Latest compiled and minified JavaScript -->
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.5/js/bootstrap.min.js" integrity="sha512-K1qjQ+NcF2TYO/eI3M6v8EiNYZfA95pQumfvcVrTHtwQVDG+aHRqLi/ETn2uB+1JqwYqVG3LIvdm9lj6imS/pQ==" crossorigin="anonymous"></script>

        <script type="text/javascript">
            $('#regid').css("color", "#212529");
            $('#regeditid').css("color", "#212529");
            $('#changeid').css("color", "blue");
            $('#Inquiryid').css("color", "#212529");
         var id = '@Request.RequestContext.HttpContext.Session["ID"]';
    var userid = '@Request.RequestContext.HttpContext.Session["UserID"]';
    var usertype = '@Request.RequestContext.HttpContext.Session["UserType"]';
    if (usertype == "14") {

        //checklogin(userid, id)
    }
    function checklogin(userid, id) {
        $.ajax({
            url: '@Url.Action("GetdataSessionlogin", "GetdataCenter")',
            data: {
                UsrID: userid,
                SessionId: id

            },
            type: "POST",
            dataType: "JSON",
            success: function (data) {
                var splitstring = data.StrStstuslogin;
                //console.log(splitstring);
                let text = splitstring;
                const myArray = text.split("|");
                let mysession = myArray[1];
                let mystatus = myArray[0];
                // console.log("mystatus " + mystatus + "//////" + "mysession " + mysession);
                if (id != mysession) {
                    $("#texterror").empty();
                    $("#texterror").text("ขออภัย ท่านทำรายการเกินระยะเวลาที่กำหนด กรุณาเข้าใช้งานใหม่อีกครั้ง");
                    //  $("#btn_click").trigger("click");
                    $("#myModal").modal();
                    //  $('#myModal').modal({ backdrop: 'static', keyboard: false }, 'show');
                    //$("#myModal").modal();
                    return false;
                    //window.location.replace("../Account/LogIn");
                } else {

                    if (mystatus == "0") {
                        $("#texterror").empty();
                        $("#texterror").text("ขออภัย ท่านทำรายการเกินระยะเวลาที่กำหนด กรุณาเข้าใช้งานใหม่อีกครั้ง");
                        //$("#btn_click").trigger("click");
                        // $('#myModal').modal({ backdrop: 'static', keyboard: false }, 'show');
                        $("#myModal").modal();
                        return false;
                        //window.location.replace("../Account/LogIn");
                    }
                }
            }
        });
    }
    $(document).on("click", "#myModal", function () {

        // $('#myModal3').click(function () {
        if (usertype == "14") {
            $("#myModal").modal({ backdrop: "static" });
        }
    });
    $('#btnlogin').click(function () {
        if (usertype == "14") {
            //  window.location.replace("Account/LogIn");

            var loc = window.location;
            var pathName = loc.pathname.substring(0, loc.pathname.lastIndexOf('/') + 1);
            var currentURL = loc.href.substring(0, loc.href.length - ((loc.pathname + loc.search + loc.hash).length - pathName.length));

            window.location.replace(currentURL + "LogIn");
        }
    });

    if (usertype == "14") {
        $(window).on('load', function () {
            //alert("load")
            checklogin(userid, id)
        });
        window.onclick = function () {
            //alert("onclick")
            checklogin(userid, id)
        };
        $('.navbar-nav').click(function () {
            // alert("navbar-nav")
            checklogin(userid, id)

        });
        $('a').click(function () {
            //  alert("a")
            checklogin(userid, id)

        });
        //$(document).bind('keypress.session', function (ed, e) {
        //    checklogin(userid, id)
        //});
        $(document).bind('mousedown keydown', function (ed, e) {

            checklogin(userid, id)
        });
        $(window).scroll(function (e) {

            checklogin(userid, id)
        });

    }


    function urllogin()
    {
        var loc = window.location;
        var pathName = loc.pathname.substring(0, loc.pathname.lastIndexOf('/') + 1);
        var currentURL = loc.href.substring(0, loc.href.length - ((loc.pathname + loc.search + loc.hash).length - pathName.length));

        window.location.replace(currentURL + "LogIn");
    }

            function CvalidatePassword() {

                var password = document.getElementById("password")
          , confirm_password = document.getElementById("confirm_password");

                function validatePassword() {
                    if (password.value != confirm_password.value) {
                        confirm_password.setCustomValidity("Passwords Don't Match");
                    } else {
                        confirm_password.setCustomValidity('');
                    }
                }

                password.onchange = validatePassword;
                confirm_password.onkeyup = validatePassword;
            }

            function verifyPassword() {

                var pw = document.getElementById("confirm_password").value;
                //alert(pw)
                //check empty password field
                if (pw == "") {
                    document.getElementById("messagex").innerHTML = "**Fill the password please!";
                    return false;
                }

                //minimum password length validation
                if (pw.length < 8) {
                    document.getElementById("messagex").innerHTML = "**Password length must be atleast 8 characters";
                    return false;
                }

                //maximum length of password validation
                if (pw.length > 15) {
                    document.getElementById("messagex").innerHTML = "**Password length must not exceed 15 characters";
                    return false;
                } else {
                    alert("Password is correct");
                }
            }

            var myInputcf = document.getElementById("confirm_password");
            var lettercf = document.getElementById("letter");
            var capitalcf = document.getElementById("capital");
            var numbercf = document.getElementById("number");
            var lengthcf = document.getElementById("length");
            // When the user clicks on the password field, show the message box
            myInputcf.onfocus = function () {
                document.getElementById("message").style.display = "block";
            }

            // When the user clicks outside of the password field, hide the message box
            myInputcf.onblur = function () {
                document.getElementById("message").style.display = "none";
            }

            // When the user starts to type something inside the password field
            myInputcf.onkeyup = function () {
                // Validate lowercase letters
                var lowerCaseLetters = /[a-z]/g;
                if (myInputcf.value.match(lowerCaseLetters)) {
                    lettercf.classList.remove("invalid");
                    lettercf.classList.add("valid");
                } else {
                    lettercf.classList.remove("valid");
                    lettercf.classList.add("invalid");
                }

                // Validate capital letters
                var upperCaseLetters = /[A-Z]/g;
                if (myInputcf.value.match(upperCaseLetters)) {
                    capitalcf.classList.remove("invalid");
                    capitalcf.classList.add("valid");
                } else {
                    capitalcf.classList.remove("valid");
                    capitalcf.classList.add("invalid");
                }

                // Validate numbers
                var numbers = /[0-9]/g;
                if (myInputcf.value.match(numbers)) {
                    numbercf.classList.remove("invalid");
                    numbercf.classList.add("valid");
                } else {
                    numbercf.classList.remove("valid");
                    numbercf.classList.add("invalid");
                }

                // Validate length
                if (myInputcf.value.length >= 8) {
                    lengthcf.classList.remove("invalid");
                    lengthcf.classList.add("valid");
                } else {
                    lengthcf.classList.remove("valid");
                    lengthcf.classList.add("invalid");
                }
            }



            //ยืนยัน///
            var myInputcf = document.getElementById("confirm_password1");
            var lettercf = document.getElementById("letter1");
            var capitalcf = document.getElementById("capital1");
            var numbercf = document.getElementById("number1");
            var lengthcf = document.getElementById("length1");
            // When the user clicks on the password field, show the message box
            myInputcf.onfocus = function () {
                document.getElementById("message1").style.display = "block";
            }

            // When the user clicks outside of the password field, hide the message box
            myInputcf.onblur = function () {
                document.getElementById("message1").style.display = "none";
            }

            // When the user starts to type something inside the password field
            myInputcf.onkeyup = function () {
                // Validate lowercase letters
                var lowerCaseLetters = /[a-z]/g;
                if (myInputcf.value.match(lowerCaseLetters)) {
                    lettercf.classList.remove("invalid1");
                    lettercf.classList.add("valid1");
                } else {
                    lettercf.classList.remove("valid1");
                    lettercf.classList.add("invalid1");
                }

                // Validate capital letters
                var upperCaseLetters = /[A-Z]/g;
                if (myInputcf.value.match(upperCaseLetters)) {
                    capitalcf.classList.remove("invalid1");
                    capitalcf.classList.add("valid1");
                } else {
                    capitalcf.classList.remove("valid1");
                    capitalcf.classList.add("invalid1");
                }

                // Validate numbers
                var numbers = /[0-9]/g;
                if (myInputcf.value.match(numbers)) {
                    numbercf.classList.remove("invalid1");
                    numbercf.classList.add("valid1");
                } else {
                    numbercf.classList.remove("valid1");
                    numbercf.classList.add("invalid1");
                }

                // Validate length
                if (myInputcf.value.length >= 8) {
                    lengthcf.classList.remove("invalid1");
                    lengthcf.classList.add("valid1");
                } else {
                    lengthcf.classList.remove("valid1");
                    lengthcf.classList.add("invalid1");
                }
            }
            //////




            function check() {

                var input = $('#cfpassword').val()
                if (input.value != $('#password').val()) {
                    input.setCustomValidity('Password Must be Matching.');

                } else {
                    // input is valid -- reset the error message
                    input.setCustomValidity('');

                }
            }


            $("#cap_cancel").click(function () {


            });
            $(".toggle-password").click(function () {

                $(this).toggleClass("fa-eye fa-eye-slash");
                var input = $($(this).attr("toggle"));
                if (input.attr("type") == "password") {
                    input.attr("type", "text");
                } else {
                    input.attr("type", "password");
                }
            });
            $(".toggle-cfpassword").click(function () {

                $(this).toggleClass("fa-eye fa-eye-slash");
                var input = $($(this).attr("toggle"));
                if (input.attr("type") == "password") {
                    input.attr("type", "text");
                } else {
                    input.attr("type", "password");
                }
            });
            $(".toggle-cfpassword1").click(function () {

                $(this).toggleClass("fa-eye fa-eye-slash");
                var input = $($(this).attr("toggle"));
                if (input.attr("type") == "password") {
                    input.attr("type", "text");
                } else {
                    input.attr("type", "password");
                }
            });
            $().ready(function () {
                // validate the comment form when it is submitted
                $("#commentForm").validate();

                // validate signup form on keyup and submit
                $("#signupForm").validate({
                    rules: {

                        confirm_password: {
                            required: true,
                            minlength: 8
                        }, confirm_password1: {
                            required: true,
                            minlength: 8
                        },

                    },
                    messages: {

                        confirm_password: {
                            required: "กรุณาใส่ รหัสผ่านใหม่",
                            minlength: "รหัสผ่านต้องมีความยาว 8 ตัวอักษร"
                        },
                        confirm_password1: {
                            required: "กรุณาใส่ ยืนยันรหัสผ่านใหม่",
                            minlength: "รหัสผ่านต้องมีความยาว 8 ตัวอักษร"
                            /// equalTo: "กรุณา ยืนยันรหัสผ่านใหม่ รหัสผ่านไม่ตรงกัน"
                        },


                    }
                });


            });


            $.validator.setDefaults({
                submitHandler: function () {
                    // alert("submitted!");

                    // var b_password = $('#password').val();
                    // var b_cfpassword = $('#confirm_password').val();

                    //var b_userid = $('#InputEmail1').val();

                    var pw = document.getElementById("confirm_password").value;

                    //check empty password field
                    //if (pw == "") {
                    //    document.getElementById("messagex").innerHTML = "**Fill the password please!";
                    //    return false;
                    //}/[A-Z]/g
                    if (/[0-9]/.test(pw) && /[a-z]/.test(pw) && /[A-Z]/.test(pw)) {
                       // document.getElementById("messagex").innerHTML = "**รหัสของคุณผ่านปลอดภัย";
                    }
                    else { document.getElementById("messagex").innerHTML = "**รหัสผ่านของคุณไม่ปลอดภัย"; return false; }

                    //minimum password length validation
                    if (pw.length < 8) {
                        document.getElementById("messagex").innerHTML = "**รหัสผ่านของคุณต้องมีความยาว 8 ตัวอักษร";
                        return false;
                    }

                    $("#overlay").fadeIn(300);
                    $.ajax({
                        url: '@Url.Action("savechangepassword", "Account")',
                        data: {
                            b_name: $('#InputEmail1').val(),

                            b_cfpassword: $('#confirm_password').val(),

                        },
                        type: "POST",
                        dataType: "JSON",
                        success: function (data) {
                            // alert(data.message)
                            // $("#meassagetext").html(data.message);
                            if (data.message == "Y") {
                              
                                $("#hiddenclick").trigger("click");

                            } else {
                                alert(data.message);
                                return false;
                                //$("#meassagetext").html("Password is correct")
                                // $("#meassagetext").removeClass('weak-password');
                                // $("#meassagetext").addClass('strong-password');
                                // $('#savepas').removeAttr("disabled");
                            }
                        }
                    }).done(function () {
                        setTimeout(function () {
                            $("#overlay").fadeOut(300);
                        }, 500);
                    });
                }

            });

        </script>







</body>
</html>
